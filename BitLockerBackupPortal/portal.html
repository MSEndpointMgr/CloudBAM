<!doctype html>
<html lang="en">
        <head>
            <!-- Required meta tags -->
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
            <meta name="description" content="CloudBAM Portal">
            <meta name="author" content="Michael Mardahl - MSEndpointMgr">
            <meta name="AADinfo" content="xxxxAADINFOxxxx">

            <!-- Bootstrap CSS -->
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-peeper@1.0.2/src/css/jquery-peeper.css" integrity="sha256-8gXPAgdsJhsYEMbZnEeg7VvjjMIeWUr9l1Iqc4S7fi4=" crossorigin="anonymous">
            <style>
                /* Enable darkmode in a Bootstrap Page with toggle function switch*/
                body {
                    background-color: var(--bs-light);
                    color: var(--bs-dark);
                }
                .navbar-nav .nav-link {
                    color: rgba(0,0,0,.55);
                }
                .navbar-nav .nav-link.active, .navbar-brand {
                    color: var(--bs-dark);
                }
                .table{
                    color: var(--bs-dark);
                }
                /* dark switch*/
                body.dark-theme {
                    background-color: var(--bs-dark);
                    color: var(--bs-light);
                }
                body.dark-theme .navbar-nav .nav-link {
                    color: rgba(255,255,255,.55);
                }
                body.dark-theme .navbar-nav .nav-link.active, body.dark-theme .navbar-brand {
                    color: var(--bs-light);
                }
                body.dark-theme .table{
                    color: var(--bs-light);
                }

                @media (prefers-color-scheme: dark) {
                    /* defaults to dark theme */
                    body {
                        background-color: var(--bs-dark);
                        color: var(--bs-light);
                    }
                    .navbar-nav .nav-link {
                        color: rgba(255,255,255,.55);
                    }
                    .navbar-nav .nav-link.active, .navbar-brand{
                        color: var(--bs-light);
                    }
                    .table{
                        color: var(--bs-light);
                    }
                    /* light switch*/
                    body.light-theme {
                        background-color: var(--bs-light);
                        color: var(--bs-dark);
                    }
                    body.light-theme .navbar-nav .nav-link {
                        color: rgba(0,0,0,.55);
                    }
                    body.light-theme .navbar-nav .nav-link.active, body.light-theme .navbar-brand {
                        color: var(--bs-dark);
                    }
                    body.light-theme .table{
                        color: var(--bs-dark);
                    }
                }

                /* logo */
                .navbar-brand img {
                    height: 1.50rem;
                    padding-right: 0.50rem;
                }

                /* center the content in a focus area */
                .focusArea {
                    padding: 3rem 1.5rem;
                    text-align: center;
                }


            </style>
            <title>CloudBAM</title>
        </head>
    	<body>

            <nav class="navbar navbar-expand-lg">
                <div class="container-fluid">
                  <a class="navbar-brand" href="#"><img src="https://avatars.githubusercontent.com/u/30185934?s=200&v=4" />CloudBAM</a>
                  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                  </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item">
                                <a class="nav-link active" id="searchPageLink" href="#">
                                    Search
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="archivePageLink" href="#">
                                    Archive
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Docs
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                                    <li><a class="dropdown-item" href="https://docs.microsoft.com/windows/security/information-protection/bitlocker/bitlocker-overview" target="_new">Bitlocker overview</a></li>
                                    <li><a class="dropdown-item" href="https://msendpointmgr.com/2021/01/12/migrate-bitlocker-to-azure-ad/" target="_new">Migrate BitLocker to Azure AD</a></li>
                                </ul>
                            </li>
                        </ul>
                        <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">xxxxUSERNAMExxxx</a> <button id="darkMode-toggle" class="btn btn-secondary">Toggle Dark-Mode</button>
                    </div>
                </div>
            </nav>

              
            <main role="main" class="container" id="mainContainer">
                <div class="focusArea"></div>
                    <!-- SEARCH PAGE -->
                    <div id="searchPageContent">
                        <h1>Get a BitLocker Recovery Key</h1>
                        <p>Use this page if you are locked out of Windows by BitLocker and need to get a BitLocker Recovery Key to regain access to Windows.</p>
                        <p>NOTE: for security reasons, <abbr class="text-danger" title="This is controlled by conditional access session lifetime.">your session lifetime might be set to expire after only a few mintues of inactivity.</abbr> You will need re-enter your information into the form on this page if it expires.</p>

                        <form method="GET" action="#" id="searchForm">
                            <p>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text" id="formRecoveryKeyID2" style="width: 14rem;">Recovery key ID:</span>
                                    <input name="key" minlength="36" id="searchKey2" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" type="text" class="form-control" aria-label="RecoveryKeyId" aria-describedby="formRecoveryKeyID2" required>
                                </div>
                            </p>
                            <p>
                                <div class="input-group input-group-lg">
                                    <label class="input-group-text" for="formReason2" style="width: 14rem;">Reason:</label>
                                    <select class="form-select form-select-lg" id="formReason2" name="reason" required>
                                        <option value="">Select...</option>
                                        <option value="1">BIOS/TPM Changed</option>
                                        <option value="2">OS Files Modified</option>
                                        <option value="3">Lost PIN/Passphrase</option>
                                    </select>
                                </div>
                            </p>
                            <p>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text" id="formNote2" style="width: 14rem;">Note (optional):</span>
                                    <input name="note" minlength="0" maxlength="200" id="SearchKey2Note" placeholder="Ticket number or extra info." type="text" class="form-control" aria-label="RecoveryKeyId" aria-describedby="formNote2">
                                </div>
                            </p>
                            <p>
                                <button type="submit" class="btn btn-primary btn-lg" id="searchSubmit2">Get Key</button>
                            </p>
                        </form>
                        <hr/>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">Key</th>
                                </tr>
                            </thead>
                            <tbody id="resultsList2">
                            </tbody>
                        </table>
                        <div class="progress start-hidden position-absolute top-50 start-50 translate-middle w-75 shadow fs-5" style="height: 2rem;" id="progBar2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                    </div>
                    
                    <!-- ARCHIVE PAGE -->
                    <div id="archivePageContent" class="start-hidden">
                        <h1>Bitlocker recovery key archive search</h1>
                        <p>Search the bitlocker archive (minimum input is the first two digits of the key)</p>
                        <form method="GET" action="#" id="archiveForm">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text" id="formRecoveryKeyID1" style="width: 14rem;">Recovery key ID:</span>
                                <input name="key" minlength="2" id="searchKey1" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" type="text" class="form-control" aria-label="RecoveryKeyId" aria-describedby="formRecoveryKeyID1" required>
                            </div>
                            <p>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text" id="formNote1" style="width: 14rem;">Note (required):</span>
                                    <input name="note" minlength="0" maxlength="200" id="SearchKey1Note" placeholder="Ticket number or extra info." type="text" class="form-control" aria-label="RecoveryKeyId" aria-describedby="formNote1" required>
                                </div>
                            </p>
                            <p>
                                <button type="submit" class="btn btn-primary btn-lg" id="searchSubmit1">Search!</button>
                            </p>
                        </form>
                        <hr/>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">Key</th>
                                </tr>
                            </thead>
                            <tbody id="resultsList1">
                            </tbody>
                        </table>
                        <div class="progress start-hidden position-absolute top-50 start-50 translate-middle w-75 shadow fs-5" style="height: 2rem;" id="progBar1">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                    </div>

                </div>
            </main>


        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.7/jquery.inputmask.min.js" integrity="sha512-jTgBq4+dMYh73dquskmUFEgMY5mptcbqSw2rmhOZZSJjZbD2wMt0H5nhqWtleVkyBEjmzid5nyERPSNBafG4GQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>        
        <script src="https://cdn.jsdelivr.net/npm/jquery-peeper@1.0.2/dist/js/jquery-peeper.min.js" integrity="sha256-qdOvCMjPLM8/5qlXZLJSevNpKzPFIBA6STcBvAgI+NE=" crossorigin="anonymous"></script>
        <script>
            $(document).ready(function() {
                console.log( "ready for action!" );

                //Hide elements from initial view
                $('.start-hidden').hide();

                // Darkmode toggle stuff
                const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");
                $('#darkMode-toggle').click(function(e){
                    if (prefersDarkScheme.matches) {
                        document.body.classList.toggle("light-theme");
                    } else {
                        document.body.classList.toggle("dark-theme");
                    }
                });

                // Hide recovery key thingy
                $(function() {
                    $(".secretBox").peeper({
                        mask: true, // show mask
                    });
                });

                //RecoveryKey input fixer (xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
                //$("#searchKey1").inputmask("********-****-****-****-************");
                $("#searchKey2").inputmask("********-****-****-****-************");

                //Page switching

                    //Archive
                    $('#archivePageLink').click(function(e){
                        $('#searchPageContent').hide();
                        $("#searchPageLink").removeClass("active");
                        
                        $('#archivePageContent').show();
                        $("#archivePageLink").addClass("active");
                    });

                    //Search
                    $('#searchPageLink').click(function(e){
                        $('#archivePageContent').hide();
                        $("#archivePageLink").removeClass("active");
                        
                        $('#searchPageContent').show();
                        $("#searchPageLink").addClass("active");
                    });

                // Form stuff

                    // ArchiveFORM - Async submit the search query and show progress etc.     
                    $("#archiveForm").submit(function(e){
                        //prevent form form actually submitting to another page
                        console.log( "Starting the archive search query against the API" );
                        e.preventDefault();
                        $('#progBar1').fadeIn('slow');
                        $(".progress-bar").addClass("progress-bar-striped progress-bar-animated");
                        $('.progress-bar').css('width', '14'+'%').attr('aria-valuenow', '14').html('14'+'%');
                        $('#searchSubmit1').attr("disabled", true);
                        var queryURL = "/api/BitlockerPortal?key=" + $( "input#searchKey1" ).val() + "&reason=999&note=" + $("input#SearchKey1Note").val();
                        $.getJSON(queryURL, function( data ){

                            $('.progress-bar').css('width', '47'+'%').attr('aria-valuenow', '47').html('47'+'%');

                            $.each( data, function( key, val ) {
                                $("#resultsList1").append("<tr><td class='font-monospace h5' id='" + key + "'>" + key + "</td><td class='secretBox font-monospace h5'>" + val + "</td></tr>")

                            });

                            $('.progress-bar').css('width', '100'+'%').attr('aria-valuenow', '100').html('100'+'%');
                            $(".progress-bar").removeClass("progress-bar-striped progress-bar-animated");
                                
                            $('#searchSubmit1').attr("disabled", false);
                            $('#progBar1').fadeOut(5000);
                        });
                    });

                    // SearchFORM - Async submit the search query and show progress etc.     
                    $("#searchForm").submit(function(e){
                        //prevent form form actually submitting to another page
                        console.log( "Starting the recovery key search query against the API" );
                        e.preventDefault();
                        $('#progBar2').fadeIn('slow');
                        $(".progress-bar").addClass("progress-bar-striped progress-bar-animated");
                        $('.progress-bar').css('width', '14'+'%').attr('aria-valuenow', '14').html('14'+'%');
                        $('#searchSubmit2').attr("disabled", true);
                        var queryURL = "/api/BitlockerPortal?key=" + $( "input#searchKey2" ).val() + "&reason=" + $("#formReason2 option:selected").val() + "&note=" + $("input#SearchKey2Note").val();
                        $.getJSON(queryURL, function( data ){

                            $('.progress-bar').css('width', '47'+'%').attr('aria-valuenow', '47').html('47'+'%');

                            var items = [];
                            $.each( data, function( key, val ) {
                                items.push( "<td class='font-monospace' id='" + key + "'>" + key + "</td><td class='secretBox font-monospace'>" + val + "</td>" );
                            });
                            
                            $( "<tr/>", {
                                html: items.join( "" )
                            }).appendTo( "#resultsList2" );

                            $('.progress-bar').css('width', '100'+'%').attr('aria-valuenow', '100').html('100'+'%');
                            $(".progress-bar").removeClass("progress-bar-striped progress-bar-animated");
                                
                            $('#searchSubmit2').attr("disabled", false);
                            $('#progBar2').fadeOut(5000);
                        });
                    });
            });
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	</body>
</html>